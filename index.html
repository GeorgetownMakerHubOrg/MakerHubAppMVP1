<!DOCTYPE html>
<html>
  <head>
    <base target="_top">

  <?!= include("STYLESHEET"); ?>    
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js" integrity="sha384-feJI7QwhOS+hwpX2zkaeJQjeiwlhOP+SdQDqhgvvo1DsjtiSQByFdThsxO669S2D" crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  
  
  </head>
  
  <body>
  <div class="mainbody">
  <div class="searchbody">
  Search NetID: <input id="netidinput" size=10>
  <span class="searchgo">search</span>
  </div>
  
  
  </div>
  <div class="userInfo">
 <span class="userName"></span>
  </div> 
  <div class="userMeritBadgeScreen">
   <ul class="userMeritBadgeList">
   
   </ul>
  
  
  </div>
  
  
  <script>
  // this runs when the page is done loading.
  var meritBadges = false;
  var allUserData = false;
  var thisUserData = false;
  
  function getMeritBadges(callback){
    google.script.run
      .withFailureHandler(function(error){console.log(error);})
      .withSuccessHandler(function(data){
        meritBadges = data;
        console.log(meritBadges);
        if(callback){callback();}
    }).getMeritBadges(); 
  }
  
  function getAllUserData(callback){
    google.script.run
      .withFailureHandler(function(error){console.log(error);})
      .withSuccessHandler(function(data){
        allUserData = data;
        console.log(allUserData);
        if(callback){callback();}
    }).getUserData(); 
  }  
  
  function getThisUserData(netid){
    console.log(netid);
    var searched_array = allUserData.userData.data.filter(function(a){
      if(netid.toLowerCase() == a.netid.toLowerCase()){
        return true;
      } else {
        return false;
      }
    });
    thisUserData = searched_array[0];
    console.log(thisUserData);  
    showUserMeritBadgeScreen();
    
    $(".userName").text(thisUserData.name);
  }
  
  
  function showUserMeritBadgeScreen(){
    console.log(thisUserData);
    $(".userMeritBadgeList").empty();
    $.each(meritBadges, function(index, meritBadge){
      console.log("'"+meritBadge+"'");
      console.log(thisUserData[meritBadge]);
      var checkElem = $("<li class='meritBadgeCheck hasMeritBadge'  data-hasMeritBadge='unknown' data-badgeName='"+meritBadge+"'><span class='hasNoHas'>dunno</span> <span class='meritBadgeText'>"+meritBadge+"</span></li>");
      if(thisUserData[meritBadge] && thisUserData[meritBadge].toLowerCase()== "yes"){
        $(checkElem).addClass("hasMeritBadge");
        $(checkElem).data('hasMeritBadge', true);
        $(".hasNoHas",checkElem).text("Has");
      }else{
        $(checkElem).addClass("noHasMeritBadge");
        $(checkElem).data('hasMeritBadge', false);
        $(".hasNoHas",checkElem).text("No Has");
      }
      $(".userMeritBadgeList").append(checkElem);

    });
    $(".meritBadgeCheck").click(function(evt){
      console.log("clicked");
      console.log($(this).data("hasMeritBadge"));
      var meritBadge = $(".meritBadgeText", this).text().trim();
      console.log($(".meritBadgeText", this).text());
      if($(this).data("hasMeritBadge")){
        $(".hasNoHas", this).text("No Has");
        $(this).removeClass("hasMeritBadge");
        $(this).addClass("noHasMeritBadge");
        $(this).data('hasMeritBadge', false);
        thisUserData[meritBadge] = "No";
      }else{
        $(".hasNoHas", this).text("Has");
        $(this).removeClass("noHasMeritBadge");
        $(this).addClass("hasMeritBadge");
        $(this).data('hasMeritBadge', true);
        thisUserData[meritBadge] = "Yes";
      }
      // update table
      
      google.script.run
        .withFailureHandler(function(error){console.log(error);})
        .withSuccessHandler(function(data){
          console.log(data);
        }).updateUserData(thisUserData.netid, thisUserData);
        
    });
  }
  
  $(function() {
    getAllUserData();    
    getMeritBadges();
    
    $(".searchgo").click(function(){
      console.log("clicked");
      var netid = $("#netidinput").val();
      getThisUserData(netid);
    });
  });
  </script>
    
  </body>
</html>


